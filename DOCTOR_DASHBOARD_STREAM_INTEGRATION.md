# Doctor Dashboard - Stream.io Video Integration Guide

This guide outlines the changes required in the Doctor Dashboard to switch from custom WebRTC to Stream.io for video consultations.

## 1. Overview

We have migrated the video backend to use **Stream Video**. The backend now acts as a token generator and session manager, while the video call logic (signaling, connection, UI) is handled by the Stream Video SDK.

## 2. Dependencies

You need to install the Stream Video SDK for your web application.

```bash
npm install @stream-io/video-react-sdk
# or
yarn add @stream-io/video-react-sdk
```

## 3. Data flow & API Changes

### Joining a Session

When the doctor clicks "Join Session", your application currently calls:
`GET /api/video/sessions/{session_id}/join`

**Old Response:**

```json
{
  "room_id": "room_123",
  "signaling_server_url": "ws://...",
  "attendee": { ... }
}
```

**New Response (Stream.io):**

```json
{
  "room_id": "21b605cd-062b-452a-9d60-05b9cf874823",
  "signaling_server_url": "YOUR_STREAM_API_KEY",
  "attendee": {
    "access_token": "eyJhbGciOiJIUzI1...", // Stream User Token
    "peer_id": "doctor_456", // Stream User ID
    "user_id": "456",
    "role": "DOCTOR"
  }
}
```

_Note: We are hijacking the `signaling_server_url` field to send you the Stream API Key temporarily to minimize backend schema changes._

## 4. Implementation Steps

### Step A: Initialize Stream Client

In your `VideoConsultation` component:

```tsx
import {
  StreamVideo,
  StreamVideoClient,
  User,
  StreamCall,
  StreamTheme,
  SpeakerLayout,
  CallControls,
} from "@stream-io/video-react-sdk";
import "@stream-io/video-react-sdk/dist/css/styles.css";

// ... inside your component ...

// 1. Get data from your API
const { attendee, room_id, signaling_server_url: apiKey } = apiResponse;

// 2. Define the user
const user: User = {
  id: attendee.peer_id, // Use the ID returned by backend
  name: "Dr. Smith", // You can get this from your auth profile
  image: "https://getstream.io/random_png/",
};

// 3. Initialize Client
const client = new StreamVideoClient({
  apiKey: apiKey,
  user: user,
  token: attendee.access_token,
});

// 4. Join the Call
const call = client.call("default", room_id);
call.join({ create: true }); // 'create: true' ensures it exists
```

### Step B: Render the Video UI

Stream provides a complete UI component set.

```tsx
return (
  <StreamVideo client={client}>
    <StreamCall call={call}>
      <StreamTheme>
        <SpeakerLayout />
        <CallControls />
      </StreamTheme>
    </StreamCall>
  </StreamVideo>
);
```

## 5. Key Points

- **Token Expiry**: The token generated by the backend expires in 1 hour by default. If the session is long, you might need to refresh it.
- **Permissions**: The backend sets the doctor as `host` and patient as `guest` automatically.
- **Chat**: Stream Video supports chat out of the box. You can add `<CallParticipantsList />` and other components easily.
