services:
  # ===================== DATABASES =====================
  # PostgreSQL for Auth Service
  auth-postgres-db:
    image: postgres:15-alpine
    container_name: auth-postgres-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: authdb
    ports:
      - "5433:5432"
    volumes:
      - auth_postgres_data:/var/lib/postgresql/data
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Profile Service
  profile-postgres-db:
    image: postgres:15-alpine
    container_name: profile-postgres-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: profiledb
    ports:
      - "5434:5432"
    volumes:
      - profile_postgres_data:/var/lib/postgresql/data
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Appointments Service
  appointments-postgres-db:
    image: postgres:15-alpine
    container_name: appointments-postgres-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: appointmentsdb
    ports:
      - "5435:5432"
    volumes:
      - appointments_postgres_data:/var/lib/postgresql/data
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Prescription Service
  prescription-postgres-db:
    image: postgres:15-alpine
    container_name: prescription-postgres-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: prescriptiondb
    ports:
      - "5436:5432"
    volumes:
      - prescription_postgres_data:/var/lib/postgresql/data
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Inventory Service
  inventory-postgres-db:
    image: postgres:15-alpine
    container_name: inventory-postgres-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: inventorydb
    ports:
      - "5437:5432"
    volumes:
      - inventory_postgres_data:/var/lib/postgresql/data
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Video Consultation Service
  video-postgres-db:
    image: postgres:15-alpine
    container_name: video-postgres-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: videodb
    ports:
      - "5438:5432"
    volumes:
      - video_postgres_data:/var/lib/postgresql/data
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===================== MESSAGE BROKER =====================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
      RABBITMQ_DEFAULT_VHOST: "/"
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ===================== API GATEWAY =====================
  kong-db:
    image: postgres:15-alpine
    container_name: kong-db
    restart: always
    environment:
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
      POSTGRES_DB: kong
    volumes:
      - kong_postgres_data:/var/lib/postgresql/data
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5

  kong-migration:
    image: kong:3.4.2
    container_name: kong-migration
    restart: on-failure
    depends_on:
      kong-db:
        condition: service_healthy
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PG_DATABASE: kong
    command: kong migrations bootstrap
    networks:
      - pulseone-network

  kong:
    image: kong:3.4.2
    container_name: kong
    restart: on-failure
    depends_on:
      - kong-migration
      - kong-db
    ports:
      - "8000:8000"
      - "8443:8443"
      - "8001:8001"
      - "8444:8444"
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PG_DATABASE: kong
      KONG_PROXY_ACCESS_LOG: "/dev/stdout"
      KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
      KONG_PROXY_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_ERROR_LOG: "/dev/stderr"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_PLUGINS: "bundled"
    networks:
      - pulseone-network
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  kong-admin-ui:
    image: pgbi/kong-dashboard:latest
    container_name: kong-admin-ui
    restart: always
    ports:
      - "8002:8080"
    environment:
      KONG_URL: "http://kong:8001"
    depends_on:
      - kong
    networks:
      - pulseone-network

  # ===================== MICROSERVICES =====================
  # Auth Service (Go)
  auth-service:
    build:
      context: .
      dockerfile: ./auth-service/Dockerfile
    container_name: auth-service
    restart: on-failure
    ports:
      - "8080:8080"
    environment:
      POSTGRES_DSN: "user=postgres password=postgres host=auth-postgres-db port=5432 dbname=authdb sslmode=disable"
      PORT: "8080"
      JWT_SECRET: ${JWT_SECRET:-dev_a_super_long_and_complex_secret_key}
      GMAIL_SMTP_EMAIL: ${GMAIL_SMTP_EMAIL:-kushanrathnayake5@gmail.com}
      GMAIL_SMTP_APP_PASSWORD: ${GMAIL_SMTP_APP_PASSWORD:-qsjs eowp wupk xqnt}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-PulseOne}
      AUTH_PUBLIC_BASE_URL: ${AUTH_PUBLIC_BASE_URL:-http://localhost:8000}
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
    depends_on:
      auth-postgres-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone-network
    deploy:
      resources:
        limits:
          memory: 256M

  # Profile Service (Spring Boot)
  profile-service:
    build:
      context: .
      dockerfile: ./profile-service/Dockerfile
    container_name: profile-service
    restart: on-failure
    ports:
      - "8082:8082"
    environment:
      SERVER_PORT: "8082"
      SERVER_ADDRESS: "0.0.0.0"
      DB_URL: "jdbc:postgresql://profile-postgres-db:5432/profiledb"
      DB_USERNAME: "postgres"
      DB_PASSWORD: "postgres"
      DB_DRIVER: "org.postgresql.Driver"
      JPA_DDL_AUTO: "update"
      JPA_SHOW_SQL: "false"
      JPA_DIALECT: "org.hibernate.dialect.PostgreSQLDialect"
      SPRING_DATASOURCE_URL: "jdbc:postgresql://profile-postgres-db:5432/profiledb"
      SPRING_DATASOURCE_USERNAME: "postgres"
      SPRING_DATASOURCE_PASSWORD: "postgres"
      SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
      SPRING_RABBITMQ_HOST: "rabbitmq"
      SPRING_RABBITMQ_PORT: "5672"
      SPRING_RABBITMQ_USERNAME: "guest"
      SPRING_RABBITMQ_PASSWORD: "guest"
      RABBITMQ_HOST: "rabbitmq"
      RABBITMQ_PORT: "5672"
      RABBITMQ_USERNAME: "guest"
      RABBITMQ_PASSWORD: "guest"
      MANAGEMENT_ENDPOINTS_EXPOSURE: "health,info"
      MANAGEMENT_HEALTH_SHOW_DETAILS: "always"
      MANAGEMENT_BASE_PATH: "/actuator"
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
      CORS_ALLOWED_HEADERS: "*"
      CORS_ALLOW_CREDENTIALS: "true"
      SWAGGER_PATH: "/api-docs"
      SWAGGER_UI_PATH: "/swagger-ui.html"
      SWAGGER_TAGS_SORTER: "alpha"
      SWAGGER_OPERATIONS_SORTER: "alpha"
      SWAGGER_DISPLAY_REQUEST_DURATION: "true"
      KAFKA_BOOTSTRAP_SERVERS: "localhost:9092"
      KAFKA_CONSUMER_GROUP_ID: "profile-service-group"
      KAFKA_CONSUMER_AUTO_OFFSET_RESET: "earliest"
      KAFKA_TRUSTED_PACKAGES: "*"
    depends_on:
      profile-postgres-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone-network
    deploy:
      resources:
        limits:
          memory: 512M

  # Appointments Service (Spring Boot)
  appointments-service:
    build:
      context: .
      dockerfile: ./appointments-service/Dockerfile
    container_name: appointments-service
    restart: on-failure
    ports:
      - "8083:8083"
    environment:
      SERVER_PORT: "8083"
      SERVER_ADDRESS: "0.0.0.0"
      DB_URL: "jdbc:postgresql://appointments-postgres-db:5432/appointmentsdb"
      DB_USERNAME: "postgres"
      DB_PASSWORD: "postgres"
      DB_DRIVER: "org.postgresql.Driver"
      JPA_DDL_AUTO: "update"
      JPA_SHOW_SQL: "false"
      JPA_DIALECT: "org.hibernate.dialect.PostgreSQLDialect"
      SPRING_DATASOURCE_URL: "jdbc:postgresql://appointments-postgres-db:5432/appointmentsdb"
      SPRING_DATASOURCE_USERNAME: "postgres"
      SPRING_DATASOURCE_PASSWORD: "postgres"
      SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
      SPRING_RABBITMQ_HOST: "rabbitmq"
      SPRING_RABBITMQ_PORT: "5672"
      SPRING_RABBITMQ_USERNAME: "guest"
      SPRING_RABBITMQ_PASSWORD: "guest"
      RABBITMQ_HOST: "rabbitmq"
      RABBITMQ_PORT: "5672"
      RABBITMQ_USERNAME: "guest"
      RABBITMQ_PASSWORD: "guest"
      RABBITMQ_VIRTUAL_HOST: "/"
      RABBITMQ_CONNECTION_TIMEOUT: "30s"
      MANAGEMENT_ENDPOINTS_EXPOSURE: "health,info"
      MANAGEMENT_HEALTH_SHOW_DETAILS: "always"
      MANAGEMENT_BASE_PATH: "/actuator"
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
      CORS_ALLOWED_HEADERS: "*"
      CORS_ALLOW_CREDENTIALS: "true"
      SWAGGER_PATH: "/api-docs"
      SWAGGER_UI_PATH: "/swagger-ui.html"
    depends_on:
      appointments-postgres-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone-network
    deploy:
      resources:
        limits:
          memory: 512M

  # Prescription Service (Go)
  prescription-service:
    build:
      context: .
      dockerfile: ./prescription-service/Dockerfile
    container_name: prescription-service
    restart: on-failure
    ports:
      - "8085:8085"
    environment:
      DB_HOST: "prescription-postgres-db"
      DB_PORT: "5432"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      DB_NAME: "prescriptiondb"
      PORT: "8085"
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
    depends_on:
      prescription-postgres-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone-network
    deploy:
      resources:
        limits:
          memory: 256M

  # Inventory Service (Spring Boot)
  inventory-service:
    build:
      context: .
      dockerfile: ./inventory-service/Dockerfile
    container_name: inventory-service
    restart: on-failure
    ports:
      - "8084:8084"
    environment:
      SERVER_PORT: "8084"
      SERVER_CONTEXT_PATH: "/"
      DB_URL: "jdbc:postgresql://inventory-postgres-db:5432/inventorydb"
      DB_USERNAME: "postgres"
      DB_PASSWORD: "postgres"
      DB_DRIVER: "org.postgresql.Driver"
      JPA_DIALECT: "org.hibernate.dialect.PostgreSQLDialect"
      JPA_DDL_AUTO: "update"
      JPA_SHOW_SQL: "false"
      JPA_BATCH_SIZE: "10"
      JPA_ORDER_INSERTS: "true"
      JPA_ORDER_UPDATES: "true"
      LOG_LEVEL_ROOT: "INFO"
      LOG_LEVEL_INVENTORY_SERVICE: "DEBUG"
      LOG_LEVEL_SPRING_WEB: "INFO"
      LOG_LEVEL_HIBERNATE_SQL: "DEBUG"
      SPRING_DATASOURCE_URL: "jdbc:postgresql://inventory-postgres-db:5432/inventorydb"
      SPRING_DATASOURCE_USERNAME: "postgres"
      SPRING_DATASOURCE_PASSWORD: "postgres"
      SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
      SPRING_RABBITMQ_HOST: "rabbitmq"
      SPRING_RABBITMQ_PORT: "5672"
      SPRING_RABBITMQ_USERNAME: "guest"
      SPRING_RABBITMQ_PASSWORD: "guest"
      RABBITMQ_HOST: "rabbitmq"
      RABBITMQ_PORT: "5672"
      RABBITMQ_USERNAME: "guest"
      RABBITMQ_PASSWORD: "guest"
      SWAGGER_PATH: "/api-docs"
      SWAGGER_UI_PATH: "/swagger-ui.html"
      SWAGGER_TAGS_SORTER: "alpha"
      SWAGGER_OPERATIONS_SORTER: "alpha"
      SWAGGER_DISPLAY_REQUEST_DURATION: "true"
    depends_on:
      inventory-postgres-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone-network
    deploy:
      resources:
        limits:
          memory: 512M

  # Video Consultation Service (Python FastAPI)
  video-consultation-service:
    build:
      context: ./video-consultation-service
      dockerfile: Dockerfile
    container_name: video-consultation-service
    restart: on-failure
    ports:
      - "8086:8086"
    environment:
      APP_NAME: "Video Consultation Service"
      VERSION: "1.0.0"
      DEBUG: "False"
      PORT: "8086"
      HOST: "0.0.0.0"
      DATABASE_URL: "postgresql+asyncpg://postgres:postgres@video-postgres-db:5432/videodb"
      DB_HOST: "video-postgres-db"
      DB_PORT: "5432"
      DB_NAME: "videodb"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-AKIARSCWF3UWZ2CZ5GP5}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-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}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_CHIME_ENDPOINT: "https://service.chime.aws.amazon.com"
      S3_BUCKET_NAME: "pulseone-video-recordings"
      RABBITMQ_HOST: "rabbitmq"
      RABBITMQ_PORT: "5672"
      RABBITMQ_USER: "guest"
      RABBITMQ_PASSWORD: "guest"
      RABBITMQ_VHOST: "/"
      RABBITMQ_EXCHANGE: "user-events-exchange"
      JWT_SECRET_KEY: ${JWT_SECRET:-3fb7bad1a0d1cd72dc13fa99ac2e870c7e9b7927a17fbff5de0e24e29e5e9e2f}
      JWT_ALGORITHM: "HS256"
      JWT_EXPIRATION_MINUTES: "60"
      AUTH_SERVICE_URL: "http://auth-service:8080"
      PROFILE_SERVICE_URL: "http://profile-service:8082"
      APPOINTMENTS_SERVICE_URL: "http://appointments-service:8083"
      DEFAULT_CONSULTATION_DURATION_MINUTES: "30"
      MAX_CONSULTATION_DURATION_MINUTES: "120"
      MIN_CONSULTATION_DURATION_MINUTES: "15"
      AWS_FREE_TIER_ATTENDEE_MINUTES: "1000"
      ENABLE_USAGE_TRACKING: "True"
      MAX_ATTENDEES_PER_MEETING: "2"
    depends_on:
      video-postgres-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone-network
    deploy:
      resources:
        limits:
          memory: 512M

volumes:
  auth_postgres_data:
  profile_postgres_data:
  appointments_postgres_data:
  prescription_postgres_data:
  inventory_postgres_data:
  video_postgres_data:
  kong_postgres_data:

networks:
  pulseone-network:
    driver: bridge
